<ion-header translucent="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/products"></ion-back-button>
    </ion-buttons>

    <ion-title class="title">Detalle Producto</ion-title>

    <ion-buttons slot="end">
      <ion-button fill="clear" aria-label="Más" (click)="openMore()">
        <ion-icon slot="icon-only" name="ellipsis-vertical"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <!-- ===== Skeleton ===== -->
  <ng-container *ngIf="loading; else loaded">
    <div class="gallery">
      <ion-skeleton-text animated style="width: 100%; height: 220px; border-radius: 14px;"></ion-skeleton-text>
      <div class="thumbs">
        <ion-skeleton-text animated style="width:48px;height:48px;border-radius:10px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width:48px;height:48px;border-radius:10px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width:48px;height:48px;border-radius:10px;"></ion-skeleton-text>
        <ion-skeleton-text animated style="width:48px;height:48px;border-radius:10px;"></ion-skeleton-text>
      </div>
    </div>

    <div class="section">
      <div class="title-row">
        <div class="title-col">
          <h1 class="name">
            <ion-skeleton-text animated style="width: 60%"></ion-skeleton-text>
          </h1>
          <ion-chip class="chip">
            <ion-label><ion-skeleton-text animated style="width: 80px"></ion-skeleton-text></ion-label>
          </ion-chip>
        </div>
        <span class="status-pill">
          <ion-skeleton-text animated style="width: 56px"></ion-skeleton-text>
        </span>
      </div>

      <div class="block">
        <h3 class="label">Descripción</h3>
        <p class="value"><ion-skeleton-text animated style="width: 90%"></ion-skeleton-text></p>
      </div>
      <div class="block">
        <h3 class="label">Precio de venta ($)</h3>
        <p class="value"><ion-skeleton-text animated style="width: 30%"></ion-skeleton-text></p>
      </div>
      <div class="block">
        <h3 class="label">Precio de costo ($)</h3>
        <p class="value"><ion-skeleton-text animated style="width: 30%"></ion-skeleton-text></p>
      </div>
      <div class="block">
        <h3 class="label">Proveedor</h3>
        <p class="value"><ion-skeleton-text animated style="width: 55%"></ion-skeleton-text></p>
      </div>
    </div>
  </ng-container>

  <!-- ===== Content ===== -->
  <ng-template #loaded>
    <ng-container *ngIf="product; else errorTpl">
      <!-- Galería -->
      <div class="gallery">
        <div class="hero-img">
          <img *ngIf="heroImage; else noImage" [src]="heroImage" alt="Imagen de producto" />
          <ng-template #noImage><div class="noimg"></div></ng-template>
        </div>

        <div class="thumbs">
          <div class="thumb-wrap" *ngFor="let img of product.images; index as i">
            <button class="thumb" (click)="selectImage(i)" [class.thumb--active]="i === selectedIndex">
              <img [src]="img" alt="Miniatura" />
            </button>
            <button class="thumb-delete" (click)="confirmDeleteImage(img); $event.stopPropagation()" aria-label="Eliminar imagen">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>

          <button class="thumb thumb--add" (click)="triggerUpload()" aria-label="Añadir imagen">
            <ion-icon name="add-outline"></ion-icon>
          </button>
          <input #fileInput type="file" accept="image/*" hidden (change)="handleUpload($event)" />
        </div>
      </div>

      <!-- Datos -->
      <div class="section">
        <div class="title-row">
          <div class="title-col">
            <h1 class="name">{{ product.name }}</h1>
            <!-- chip categoría bajo el nombre -->
            <ion-chip class="chip" *ngIf="product.categoryName">
              <ion-label>{{ product.categoryName }}</ion-label>
            </ion-chip>
          </div>

          <span class="status" [ngClass]="product.status === 'Activo' ? 'status--activo' : 'status--inactivo'">
            {{ product.status }}
          </span>
        </div>

        <div class="block" *ngIf="product.description">
          <h3 class="label">Descripción</h3>
          <p class="value">{{ product.description }}</p>
        </div>

        <div class="block">
          <h3 class="label">Precio de venta ($)</h3>
          <p class="value">{{ product.salePrice | number:'1.2-2' }}</p>
        </div>

        <div class="block">
          <h3 class="label">Precio de costo ($)</h3>
          <p class="value">{{ product.costPrice | number:'1.2-2' }}</p>
        </div>

        <!-- Proveedor debajo del costo -->
        <div class="block">
          <h3 class="label">Proveedor</h3>
          <p class="value">{{ product.providerName || 'Sin proveedor' }}</p>
        </div>
      </div>

      <!-- Inventario -->
      <div class="inventory">
        <div class="inventory__head">
          <h3>Inventario</h3>
          <ion-button fill="clear" size="small" (click)="editInventory()">Editar stock</ion-button>
        </div>

        <div class="inventory__row">
          <div class="item">
            <div class="item__label">Stock actual</div>
            <div class="item__value">{{ product.stockActual }}</div>
          </div>
          <div class="item" *ngIf="product.stockMin !== undefined">
            <div class="item__label">Stock mínimo</div>
            <div class="item__value">{{ product.stockMin }}</div>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-template #errorTpl>
      <div class="error-state">
        <p>{{ error || 'No se pudo cargar el producto.' }}</p>
        <ion-button fill="outline" (click)="reload()">Reintentar</ion-button>
      </div>
    </ng-template>
  </ng-template>

  <!-- ===== Modal Edición ===== -->
  <ion-modal [isOpen]="editOpen" (didDismiss)="closeEdit()" class="edit-modal">
    <ng-template>
      <ion-header class="edit-header">
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button fill="clear" (click)="closeEdit()" aria-label="Cerrar">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>

          <ion-title>Editar Producto</ion-title>

          <ion-buttons slot="end">
            <ion-button fill="clear" (click)="saveEdit()" aria-label="Guardar">
              <ion-icon name="checkmark-outline"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="edit-content ion-padding">
        <div class="gallery">
          <div class="hero-img">
            <img *ngIf="heroImage; else noImage" [src]="heroImage" alt="Imagen de producto" />
            <ng-template #noImage><div class="noimg"></div></ng-template>
          </div>

          <div class="thumbs">
            <div class="thumb-wrap" *ngFor="let img of product?.images; index as i">
              <button class="thumb" (click)="selectImage(i)" [class.thumb--active]="i === selectedIndex">
                <img [src]="img" alt="Miniatura" />
              </button>
              <button class="thumb-delete" (click)="confirmDeleteImage(img); $event.stopPropagation()" aria-label="Eliminar imagen">
                <ion-icon name="trash-outline"></ion-icon>
              </button>
            </div>

            <button class="thumb thumb--add" (click)="triggerUpload()" aria-label="Añadir imagen">
              <ion-icon name="add-outline"></ion-icon>
            </button>
            <input #fileInput type="file" accept="image/*" hidden (change)="handleUpload($event)" />
          </div>
        </div>

        <form (ngSubmit)="saveEdit()" class="edit-form">
          <div class="field">
            <label class="field__label">Título del producto</label>
            <ion-input class="field__control" [(ngModel)]="edit.nombre" name="nombre" autocomplete="off" placeholder="Nombre"></ion-input>
          </div>

          <div class="field">
            <label class="field__label">Descripción</label>
            <ion-textarea class="field__control" auto-grow="true" [(ngModel)]="edit.descripcion" name="descripcion" placeholder="Descripción"></ion-textarea>
          </div>

          <div class="field">
            <label class="field__label">Precio de costo ($)</label>
            <ion-input class="field__control" type="number" inputmode="decimal" step="0.01" [(ngModel)]="edit.precio_costo" name="precio_costo" placeholder="0.00"></ion-input>
          </div>

          <div class="field">
            <label class="field__label">Precio de venta ($)</label>
            <ion-input class="field__control" type="number" inputmode="decimal" step="0.01" [(ngModel)]="edit.precio_venta" name="precio_venta" placeholder="0.00"></ion-input>
          </div>

          <button type="button" class="picker" (click)="chooseCategory()">
            <div class="picker__text">
              <div class="picker__label">Categoría</div>
              <div class="picker__value">{{ edit.categoria_nombre || 'Seleccionar' }}</div>
            </div>
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>

          <button type="button" class="picker" (click)="chooseProvider()">
            <div class="picker__text">
              <div class="picker__label">Proveedor</div>
              <div class="picker__value">{{ edit.proveedor_nombre || 'Seleccionar' }}</div>
            </div>
            <ion-icon name="chevron-forward-outline"></ion-icon>
          </button>

          <div style="height:12px"></div>
          <ion-button expand="block" type="submit" class="btn-save">Guardar</ion-button>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>

<ion-footer *ngIf="product">
  <ion-toolbar class="footer">
    <ion-button expand="block" size="large" shape="round" (click)="openEdit()">
      Editar
    </ion-button>
  </ion-toolbar>
</ion-footer>
