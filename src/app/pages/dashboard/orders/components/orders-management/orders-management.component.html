<ion-header translucent="true">
  <ion-toolbar>
    <ion-title class="title">Pedidos</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" aria-label="A√±adir" (click)="onAdd()">
        <ion-icon slot="icon-only" name="add-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content fullscreen="true">
  <!-- üîé Search + Filtros (una sola barra) -->
  <div class="search-card">
    <div class="search-row">
      <ion-searchbar
        class="search"
        [(ngModel)]="query"
        placeholder="Buscar pedido"
        show-clear-button="never"
        (ionInput)="applyQueryFilter()">
      </ion-searchbar>

      <ion-button fill="outline" id="filters-trigger">
        <ion-icon slot="start" name="funnel-outline"></ion-icon>
        <span class="btn-text">Filtros</span>
        <ion-badge *ngIf="activeFiltersCount" class="filter-badge" slot="end">
          {{ activeFiltersCount }}
        </ion-badge>
      </ion-button>

      <!-- Popover de filtros -->
      <ion-popover trigger="filters-trigger" triggerAction="click" #filtersPopover>
        <ng-template>
          <ion-content class="filters-popover">
            <ion-list lines="full">
              <ion-list-header>Estados</ion-list-header>

              <ion-item button (click)="toggleEstado('confirmado')">
                <ion-checkbox slot="start" [checked]="filters.estados.has('confirmado')"></ion-checkbox>
                <ion-label>Confirmado</ion-label>
              </ion-item>

              <ion-item button (click)="toggleEstado('entregado')">
                <ion-checkbox slot="start" [checked]="filters.estados.has('entregado')"></ion-checkbox>
                <ion-label>Entregado</ion-label>
              </ion-item>

              <ion-item button (click)="toggleEstado('pendiente')">
                <ion-checkbox slot="start" [checked]="filters.estados.has('pendiente')"></ion-checkbox>
                <ion-label>Pendiente</ion-label>
              </ion-item>

              <ion-item button (click)="toggleEstado('cancelado')">
                <ion-checkbox slot="start" [checked]="filters.estados.has('cancelado')"></ion-checkbox>
                <ion-label>Cancelado</ion-label>
              </ion-item>

              <ion-list-header>Canal</ion-list-header>
              <ion-item>
                <ion-checkbox slot="start" [(ngModel)]="filters.canalWhatsapp"></ion-checkbox>
                <ion-label>Whatsapp</ion-label>
              </ion-item>

              <ion-list-header>Fecha</ion-list-header>
              <ion-item>
                <ion-select interface="popover" [(ngModel)]="filters.fecha">
                  <ion-select-option value="todas">Todas</ion-select-option>
                  <ion-select-option value="hoy">Hoy</ion-select-option>
                </ion-select>
              </ion-item>
            </ion-list>

            <div class="filters-actions">
              <ion-button fill="clear" (click)="clearAllFilters()">Limpiar</ion-button>
              <ion-button (click)="applyFilters()">Aplicar</ion-button>
            </div>
          </ion-content>
        </ng-template>
      </ion-popover>
    </div>

    <!-- chips de filtros activos -->
    <div class="chips" *ngIf="activeFiltersCount">
      <ion-chip *ngFor="let e of estadosArray" outline="true">
        <ion-label>{{ e | titlecase }}</ion-label>
        <ion-icon name="close-outline" (click)="removeFilterChip('estado', e)"></ion-icon>
      </ion-chip>

      <ion-chip *ngIf="filters.canalWhatsapp" outline="true">
        <ion-label>Whatsapp</ion-label>
        <ion-icon name="close-outline" (click)="removeFilterChip('whatsapp')"></ion-icon>
      </ion-chip>

      <ion-chip *ngIf="filters.fecha === 'hoy'" outline="true">
        <ion-label>Hoy</ion-label>
        <ion-icon name="close-outline" (click)="removeFilterChip('fecha')"></ion-icon>
      </ion-chip>
    </div>
  </div>

  <!-- Skeletons -->
  <ng-container *ngIf="loading; else loaded">
    <ion-list>
      <ion-item *ngFor="let i of [1,2,3,4,5,6]">
        <ion-label>
          <h3><ion-skeleton-text animated style="width: 60%"></ion-skeleton-text></h3>
          <p><ion-skeleton-text animated style="width: 40%"></ion-skeleton-text></p>
        </ion-label>
      </ion-item>
    </ion-list>
  </ng-container>

  <ng-template #loaded>
    <ion-card *ngIf="error">
      <ion-card-header>
        <ion-card-title>Error</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        {{ error }}
        <ion-button expand="block" fill="outline" (click)="loadAll()">Reintentar</ion-button>
      </ion-card-content>
    </ion-card>

    <ng-container *ngIf="!error">
      <!-- Lista agrupada por fecha -->
      <ng-container *ngIf="grouped.length; else empty">
        <ng-container *ngFor="let g of grouped">
          <ion-list>
            <ion-list-header class="group-header">{{ g.label }}</ion-list-header>

            <ion-item *ngFor="let o of g.items; trackBy: trackById" button>
              <ion-label>
                <h3 class="row-title">#{{ o.id }}</h3>

                <p class="row-sub">
                  ‚Ä¢ {{ asDate(o.fecha) | date:"d 'de' MMM, y 'a las' h:mm a" }}
                </p>

                <p class="row-meta">
                  <span class="meta-label">Art√≠culos:</span>
                  <span class="meta-value">{{ o.items?.length || 0 }}</span>
                  <ng-container *ngIf="o.total != null"> ‚Ä¢ ${{ o.total | number:'1.0-0' }}</ng-container>
                </p>

                <p class="row-meta" *ngIf="o.numero_celular">
                  <span class="meta-label">Tel:</span>
                  <span class="meta-value">{{ o.numero_celular }}</span>
                </p>
              </ion-label>

              <div slot="end" class="end-actions">
                <ion-badge [ngClass]="statusClass(o.estado)">{{ (o.estado || 'Sin estado') | titlecase }}</ion-badge>
                <ion-button fill="clear" size="small" (click)="openWhatsApp(o, $event)" [disabled]="!o.numero_celular">
                  <ion-icon name="logo-whatsapp"></ion-icon>
                </ion-button>
                <ion-icon class="chev" name="chevron-forward-outline"></ion-icon>
              </div>
            </ion-item>
          </ion-list>
        </ng-container>
      </ng-container>

      <ng-template #empty>
        <div class="empty">
          <img class="hero-img" src="assets/images/customers-patients.png" alt="Pedidos" />
          <h2>Sin pedidos</h2>
          <p>No hay resultados.</p>
        </div>
      </ng-template>
    </ng-container>
  </ng-template>
</ion-content>
